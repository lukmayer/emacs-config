#+title: Luke's Emacs configuration
#+PROPERTY: header-args:emacs-lisp :tangle config.el :results silent
#+auto_tangle: t

* Core
** Straight.el

For automating package installation

#+begin_src emacs-lisp
  ;; Bootstrap straight.el
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  ;; Configure use-package to use straight.el by default
  (straight-use-package 'use-package)
  (setq straight-use-package-by-default t)


  (setq package-enable-at-startup nil) ;; prevent package conflicts

#+end_src

** Basics
Alerts, toolbar, bell, line numbers

#+begin_src emacs-lisp
  (global-font-lock-mode 1)

  ;; Suppress native compilation warnings
  (setq native-comp-async-report-warnings-errors nil)

  ;; basic settings
  (setq inhibit-startup-message t)
  (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (setq visible-bell t)

  ;; lines
  (setq display-line-numbers-type t)
  (global-display-line-numbers-mode 1)
  ;; (global-hl-line-mode 1)

  ;; short answer
  (setq use-short-answers t)

  ;; attempting to make dashboard the default buffer instead of scratch
  (setq initial-buffer-choice (lambda () (get-buffer-create "*dashboard*")))

  ;; insert \n with C-n
  (setq next-line-add-newlines t)

  ;; overwrite selection when pasting
  (delete-selection-mode 1)

  ;; bracket pairs
  (electric-pair-mode 1)
  (setq electric-pair-inhibit-predicate ; exclude < from auto-complete
      (lambda (c)
        (if (char-equal c ?\<) t (electric-pair-default-inhibit c))))

  ;; line wrap
  (global-visual-line-mode 1)


#+end_src
** Auto-save
This sets auto-save/back-up files to a specific directory rather than littering them everywhere
#+begin_src emacs-lisp

  (setq auto-save-timeout 5)

  (make-directory "~/.emacs.d/auto-save-list/" t)
  (make-directory "~/.emacs.d/backups/"       t)

  (setq auto-save-file-name-transforms
        `((".*" ,(expand-file-name "auto-save-list/" user-emacs-directory) t))
        backup-directory-alist
        `((".*" . ,(expand-file-name "backups/" user-emacs-directory))))

#+end_src
** God mode
make emacs a bit more modal
#+begin_src emacs-lisp
  (use-package god-mode
    :straight t
    :init
    (setq god-mode-enable-function-key-translation nil)
    :bind (("<escape>" . god-local-mode)
           :map god-local-mode-map
           ("i" . god-local-mode))
    :config
    (god-mode-all))

  ;; making the cursor change with god mode status
  (defun my-god-mode-update-cursor ()
    (setq cursor-type (if god-local-mode '(box . size) 'box)))

  (add-hook 'god-mode-enabled-hook 'my-god-mode-update-cursor)
  (add-hook 'god-mode-disabled-hook 'my-god-mode-update-cursor)

  ;; useful keybindings
  (global-set-key (kbd "C-x C-1") #'delete-other-windows)
  (global-set-key (kbd "C-x C-2") #'split-window-below)
  (global-set-key (kbd "C-x C-3") #'split-window-right)
  (global-set-key (kbd "C-x C-0") #'delete-window)

#+end_src

* Org
#+begin_src  emacs-lisp
  (use-package org
    :straight (:type built-in)
    :hook (org-babel-after-execute . org-redisplay-inline-images)
    :custom
    (org-confirm-babel-evaluate nil)
    :config
    (require 'ob-julia)        
    (add-to-list 'org-babel-load-languages '(julia . t))
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((python . t) (R . t) (julia . t) (shell . t)
       (css . t) (js . t) (latex . t) (emacs-lisp . t)))
    
    ;; Settings
    (setq org-confirm-babel-evaluate nil
    	org-startup-with-inline-images t
    	org-babel-eval-verbose t
    	org-startup-folded 'overview
    	org-format-latex-options (plist-put org-format-latex-options :scale 1.5)
    	org-hide-emphasis-markers t))

  (require 'org-tempo)

  (use-package org-auto-tangle
    :straight t
    :hook (org-mode . org-auto-tangle-mode)   
    :custom
    (org-auto-tangle-default t)) 

  (use-package corg
    :straight (:host github :repo "isamert/corg.el")) ;; this adds auto-complete to src block header args

  (setq calendar-week-start-day 1)	; setting monday as the first day of the week

#+end_src
** Org-latex
#+begin_src emacs-lisp
  (use-package org-latex-impatient
    :straight t
    :defer t
    :hook (org-mode . org-latex-impatient-mode)
    :init
    (setq org-latex-impatient-tex2svg-bin
  	"/run/current-system/sw/bin/tex2svg"))

#+end_src
** Templates
#+begin_src emacs-lisp
  ;; expense tracking template
  (defun insert-expense-template ()
    "Insert expense template with user-specified month and year."
    (interactive)
    (let* ((month (read-string "Enter month (e.g., December): "))
           (year (read-string "Enter year (e.g., 2025): "))
           (template-file (expand-file-name "~/org/templates/expenses.org"))
           (content (with-temp-buffer
                      (insert-file-contents template-file)
                      (buffer-string))))
      ;; Replace %B with month, %Y with year
      (setq content (replace-regexp-in-string "%B" month content))
      (setq content (replace-regexp-in-string "%Y" year content))
      (insert content)))


#+end_src

** Org-agenda
#+begin_src emacs-lisp

  (require 'org-habit)
  (add-to-list 'org-modules 'org-habit)

  (add-hook 'org-after-todo-state-change-hook 'org-save-all-org-buffers)
  (setq org-habit-graph-column 60)
  (setq org-agenda-files '("~/org"))
  (setq org-log-into-drawer t)

  (global-set-key (kbd "C-c a") 'org-agenda)

  (use-package org-alert
    :straight t

    :custom
    (alert-default-style 'libnotify) 

    (org-alert-interval 300)             ;; Check every 300 seconds (5 minutes)
    (org-alert-notify-cutoff 15)         ;; Notify 15 minutes before the event 
    (org-alert-notify-after-event-cutoff 5) ;; Stop notifying 5 minute after the event starts 

    :config
    (setq alert-libnotify-priorities
        '((low . low)
          (normal . critical) 
          (high . critical)))
    (org-alert-enable))

  (setq alert-libnotify-command "/run/current-system/sw/bin/notify-send")


#+end_src

** Engrave-faces
This is meant to add code-block styling for exports
#+begin_src emacs-lisp
  (straight-use-package 'engrave-faces)
  (setq org-latex-src-block-backend 'engraved)
  (setq org-latex-engraved-theme 'modus-operandi-tritanopia)
#+end_src
** Org-modern
#+begin_src emacs-lisp
  (straight-use-package 'org-modern)
  (with-eval-after-load 'org (global-org-modern-mode))
  (setq
   org-hide-emphasis-markers t
   org-pretty-entities t
   org-agenda-tags-column 0
   org-ellipsis "â€¦")

  (global-org-modern-mode)



#+end_src

* Appearance
** Theme

#+begin_src emacs-lisp
  ;; theme
  (setq modus-themes-to-toggle '(modus-operandi-tritanopia modus-vivendi-tritanopia))

  (setq modus-themes-bold-constructs t)
  (setq modus-themes-italic-constructs t)
  (setq modus-themes-syntax '(alt-syntax))

  (setq modus-themes-fringes 'subtle)

  (setq modus-themes-common-palette-overrides
        '((border-mode-line-active unspecified)
          (border-mode-line-inactive unspecified)
  	  (bg-mode-line-active bg-active)))

  (setq modus-themes-headings
        '((1 . (rainbow overline background 1.4))
          (2 . (rainbow background 1.3))
          (3 . (rainbow bold 1.2))
          (t . (semilight 1.1))))

  (setq modus-themes-scale-headings t)

  (load-theme 'modus-vivendi-tritanopia t)

#+end_src

** Font

#+begin_src emacs-lisp

  ;; font
  (set-face-attribute
   'default nil
   :family "Iosevka Extended"
   :height 120)

  ;; ligatures
  (use-package ligature
    :straight t
    :config
    ;; Enable all Iosevka ligatures 
    (ligature-set-ligatures t
        			  '("<--" "<---" "<->" "<-->" "<--->" "<---->"
        			    "<==" "<===" "<=>" "<==>" "<===>" "<====>"
        			    "<~~" "<~" "~>" "~~>"
        			    "::" ":::" "==" "!=" "===" "!=="
        			    ":=" ":-" ":+" "<*" "<*>" "*>"
        			    "<|" "<|>" "|>" "+:" "-:" "=:" "<******>"
        			    "++" "+++"))
    (global-ligature-mode t))


#+end_src

*** Rainbow-mode

#+begin_src emacs-lisp
  (straight-use-package 'rainbow-mode)

#+end_src

** Doom Modeline

For the icons you have to run nerd-icons-install-fonts.

#+begin_src emacs-lisp
    ;; modeline
    (setq doom-modeline-support-imenu t)
    (setq doom-modeline-height 25)
    (setq doom-modeline-bar-width 1)
    (setq doom-modeline-hud t)
    (setq doom-modeline-icon t)
    (setq doom-modeline-major-mode-icon t)
    (setq doom-modeline-majornnn-mode-color-icon t)
    (setq doom-modeline-buffer-state-icon t)
    (setq doom-modeline-buffer-modification-icon t)
    (setq doom-modeline-lsp-icon t)
    (setq doom-modeline-buffer-name t)
    (setq doom-modeline-highlight-modified-buffer-name t)
    (setq doom-modeline-column-zero-based t)
    (setq doom-modeline-percent-position '(-3 "%p"))
    (setq doom-modeline-position-line-format '("L%l"))
    (setq doom-modeline-position-column-format '("C%c"))
    (setq doom-modeline-position-column-line-format '("%l:%c"))
    (setq doom-modeline-enable-word-count t)
    (setq doom-modeline-total-line-number t)

    (use-package doom-modeline
      :straight t
      :config
      (doom-modeline-mode 1))


#+end_src


** Dashboard

#+begin_src emacs-lisp
  ;; dashboard
  (straight-use-package 'dashboard)
  (require 'dashboard)
  (dashboard-setup-startup-hook)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-set-navigator t)
  (setq dashboard-vertically-center-content t)
  (setq dashboard-display-icons-p t)     
  (setq dashboard-icon-type 'nerd-icons)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (add-to-list 'dashboard-items '(agenda) t)
  (setq dashboard-week-agenda t)

  (setq dashboard-startupify-list '(dashboard-insert-navigator
                                    dashboard-insert-newline
                                    dashboard-insert-items))

  (setq dashboard-items '((recents   . 10)
  			(bookmarks . 10)
  			(agenda    . 20)))

#+end_src

** Zoom
#+begin_src emacs-lisp
  (use-package zoom
    :straight t          
    :config
    (custom-set-variables
     '(zoom-size '(0.7 . 0.7)))
    (zoom-mode 1))

#+end_src

** Rainbow-delimiters
#+begin_src emacs-lisp
  (straight-use-package 'rainbow-delimiters)
  (add-hook 'prog-mode-hook #'rainbow-delimiters-mode)

#+end_src

* Navigation
** Custom-keybindings
#+begin_src emacs-lisp
(global-set-key (kbd "C-x C-o") 'other-window) ;; this is a bit nicer for god-mode
#+end_src
** Recent files
#+begin_src emacs-lisp
;; Recent files
(recentf-mode 1)
(setq recentf-max-saved-items 50)
(global-set-key (kbd "C-x C-r") 'counsel-recentf)

#+end_src
** Which-key
To give an overview of shortcut options

#+begin_src emacs-lisp
;; which-key
(use-package which-key
  :straight t
  :config
  (which-key-mode 1))

#+end_src
** Recent commands

#+begin_src emacs-lisp
;; amx - command frequency tracking for M-x
(use-package amx
  :straight t
  :config
  (amx-mode 1))

#+end_src
** Search
*** Swiper

#+begin_src emacs-lisp
;; search
(global-set-key (kbd "C-s") #'swiper) 

#+end_src
*** Orderless
Basically fuzzy match when searching for files
#+begin_src emacs-lisp
  (use-package orderless
    :straight t
    :config
    (setq completion-styles '(orderless)
  	orderless-matching-styles '(orderless-flex)
    	read-buffer-completion-ignore-case t))

#+end_src

*** Avy (Vimium-style navigation)

#+begin_src emacs-lisp
  (use-package avy
    :straight t
    :bind
    (("C-."   . avy-goto-char-timer))) 

#+end_src

** Context: Marginalia
#+begin_src emacs-lisp
  ;; Marginalia: annotations in completion lists
  (use-package marginalia
    :straight t
    :init
    (marginalia-mode))

#+end_src
* Editing
** Auto complete
 
*** Ivy, Counsel

#+begin_src emacs-lisp
  (use-package ivy
      :straight t
      :config
      (ivy-mode 1))

  (setq ivy-re-builders-alist
      '((swiper . ivy--regex-plus)
        (t      . ivy--regex-fuzzy)))
  
  (use-package counsel
      :straight t
      :after ivy
      :config
      (require 'counsel)
      (counsel-mode 1)
      (setq ivy-use-virtual-buffers t)
      (setq ivy-initial-inputs-alist nil)) ;; Remove ^ from M-x

#+end_src

*** Company

#+begin_src emacs-lisp
  ;; company
  (use-package company
    :straight t
    :init
    (global-company-mode)
    :hook ((emacs-lisp-mode . company-mode))
    :custom
    (company-backends '((company-capf company-dabbrev-code)))
    (company-idle-delay 0.1)
    (company-minimum-prefix-length 1))

#+end_src
*** LSP-mode

#+begin_src emacs-lisp
  ;;lsp mode
  (use-package lsp-mode
    :after company
    :straight t
    :init
    (setq lsp-completion-provider :capf) 
    :hook ((python-mode . lsp-deferred)
           (ess-r-mode  . lsp-deferred)
           (julia-mode  . lsp-deferred))
    :config
    (lsp-enable-which-key-integration t))

  (use-package lsp-ui
    :straight t
    :config
    (setq lsp-ui-doc-enable t))


#+end_src

*** Minibuffer history

#+begin_src emacs-lisp
;; keep minibuffer history across sessions 
(use-package savehist
  :straight (:type built-in)     
  :init
  (savehist-mode 1))
#+end_src

** To-Do comment highlighting

#+begin_src emacs-lisp
;; hl-todo
(straight-use-package 'hl-todo)
(global-hl-todo-mode)

#+end_src

** Undo-tree

#+begin_src emacs-lisp
  (straight-use-package 'undo-tree)
  (global-undo-tree-mode)

  (global-set-key (kbd "C-x C-/") 'undo)
  ;; Bind undo-tree-visualize to a new key, e.g., C-c u
  (define-key undo-tree-map (kbd "C-c _") 'undo-tree-visualize)
  
#+end_src

* Languages
** Quarto + MD

#+begin_src emacs-lisp

  ;; modified version of quarto-mode TODO:
  (use-package quarto-mode
    :straight (:local-repo "~/code/emacs/quarto-emacs"))

  ;; markdown
  (use-package markdown-mode
    :mode ("\\.md\\'" "\\.markdown\\'")
    :config
    (setq markdown-command "pandoc"))


  (use-package better-quarto
    :straight nil          
    :load-path "~/.emacs.d/elisp/better-quarto")

  (add-hook 'quarto-mode-hook #'better-quarto-mode)

  (add-hook 'markdown-mode-hook
            (lambda ()
              (when (and buffer-file-name
                         (string-match-p "\\.\\(qmd\\|rmd\\)\\'" buffer-file-name))
                (better-quarto-mode 1))))

#+end_src

** Julia + R + Python

#+begin_src emacs-lisp
  ;; Jupyter
  (straight-use-package 'jupyter)

  ;; julia
  (use-package julia-snail
    :straight t
    :hook (julia-mode . julia-snail-mode))

  (setq julia-snail-propagate-to-indirect-buffers t)


  ;; R
  (use-package ess
    :straight t
    :hook (ess-r-mode . (lambda ()
                          (require 'lsp-mode)
                          (lsp-deferred))))

  (setq ess-eval-visibly 'nowait) ;; this should prevent blocking emacs during computation


  ;; python
  (use-package elpy
    :straight t
    :init
    (elpy-enable)
    :hook (elpy-mode . lsp-deferred))

  (setq python-shell-interpreter "ipython"
        python-shell-interpreter-args "-i --simple-prompt")



#+end_src

** Nix

#+begin_src emacs-lisp 
  ;; nix
  (use-package nix-mode
    :straight t
    :mode "\\.nix\\'")

#+end_src

** English (Spellcheck)

Dump dictionary into emacs.d for simplicity using:
aspell -d en dump master | aspell -l en expand > ~/.emacs.d/english.words

#+begin_src emacs-lisp
  (setq ispell-alternate-dictionary
        (expand-file-name "~/.emacs.d/english.words"))
#+end_src

* Applications
** Vterm
Fixing the color scheme for radian by setting a darker vterm background
#+begin_src emacs-lisp

  (custom-set-faces
   '(vterm-color-default ((t (:foreground "white" :background "#1e1e1e"))))
   '(vterm-color-black ((t (:foreground "#000000" :background "#1e1e1e"))))
   '(vterm-color-red ((t (:foreground "#ff6b6b" :background "#1e1e1e"))))
   '(vterm-color-green ((t (:foreground "#51cf66" :background "#1e1e1e"))))
   '(vterm-color-yellow ((t (:foreground "#ffd93d" :background "#1e1e1e"))))
   '(vterm-color-blue ((t (:foreground "#4ecdc4" :background "#1e1e1e"))))
   '(vterm-color-magenta ((t (:foreground "#ff6b9d" :background "#1e1e1e"))))
   '(vterm-color-cyan ((t (:foreground "#a8dadc" :background "#1e1e1e"))))
   '(vterm-color-white ((t (:foreground "#ffffff" :background "#1e1e1e")))))


  (defun vterm--get-color-advice (index &rest args)
    (cond
     ((and (>= index 0) (< index 16))
      (face-foreground (elt vterm-color-palette index) nil 'default))
     ((= index -11)
      (face-foreground 'vterm-color-underline nil 'default))
     ((= index -12)
      (face-background 'vterm-color-inverse-video nil 'default))
     (t nil)))

  (advice-add 'vterm--get-color :override #'vterm--get-color-advice)

  (global-set-key (kbd "C-c t") #'vterm)
  
#+end_src
** Magit

Emacs Git client + diff highlights

#+begin_src emacs-lisp
;; magit
(use-package magit
  :straight t
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))

;; git-gutter
(straight-use-package 'git-gutter)
(global-git-gutter-mode +1)

#+end_src

** Elfeed

#+begin_src emacs-lisp

  (use-package elfeed
    :straight t)

  (use-package elfeed-tube
    :straight t
    :after elfeed
    :demand t
    :config
    (elfeed-tube-setup))

  (use-package elfeed-org
    :straight t
    :after elfeed
    :config
    (elfeed-org)
    (setq rmh-elfeed-org-files (list "~/org/elfeed.org")))

  ;; filter condition
  (setq elfeed-search-filter "@1-week-ago +unread")
  (setq elfeed-search-parse-filter-expiry-words t)

  ;; cusom display
  (setq elfeed-show-entry-switch #'elfeed-display-buffer)
  (defun elfeed-display-buffer (buf &optional act)
    (pop-to-buffer buf)
    (set-window-text-height (get-buffer-window) (round (* 0.7 (frame-height)))))

  (defun my-elfeed-show-setup ()
    (setq-local elfeed-show-entry-switch #'elfeed-display-buffer))

  (add-hook 'elfeed-show-mode-hook #'my-elfeed-show-setup)
  (advice-add 'elfeed :after (lambda (&rest _) (elfeed-update)))

#+end_src

** Treemacs
#+begin_src emacs-lisp
  (use-package treemacs
    :straight t
    :commands treemacs)
#+end_src

** PDF-tools
#+begin_src emacs-lisp
(straight-use-package 'pdf-tools)

#+end_src
** Mu4e

Set up ~/.offlineimaprc

then run offlineimap

#+begin_src emacs-lisp

  (require 'auth-source)
  (setq auth-sources '("~/.authinfo")) 
  (setq epa-pinentry-mode 'loopback)
  (server-start)
  (straight-use-package 'pinentry)
  (pinentry-start)


  (add-to-list 'load-path "/run/current-system/sw/share/emacs/site-lisp/mu4e")
  (load-file "~/.emacs.d/email-contexts.el")

  (setq smtpmail-debug-info t)
  (setq smtpmail-debug-verbose t)
  (setq mu4e-get-mail-command "sh -c 'offlineimap -a VivaldiAccount && offlineimap -a UciAccount && mu index'")
  (setq mu4e-update-interval 600)
 
#+end_src

After config:
mu init --maildir=~/Mail \
--my-address=user1@mail.com --my-address=user2@mail.com

mu index

** EWW
Set default searche engine to SearxNG
#+begin_src emacs-lisp
(setq eww-search-prefix "http://127.0.0.1:8888/search?q=")
#+end_src













