#+title: Luke's Emacs configuration
#+PROPERTY: header-args:emacs-lisp :tangle config.el :results silent
#+auto_tangle: t

* Core
** Straight.el

For automating package installation

#+begin_src emacs-lisp
  ;; Bootstrap straight.el
  (defvar bootstrap-version)
  (let ((bootstrap-file
         (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
        (bootstrap-version 6))
    (unless (file-exists-p bootstrap-file)
      (with-current-buffer
          (url-retrieve-synchronously
           "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
           'silent 'inhibit-cookies)
        (goto-char (point-max))
        (eval-print-last-sexp)))
    (load bootstrap-file nil 'nomessage))

  ;; Configure use-package to use straight.el by default
  (straight-use-package 'use-package)
  (setq straight-use-package-by-default t)
#+end_src

** Basics
Alerts, toolbar, bell, line numbers

#+begin_src emacs-lisp
  (global-font-lock-mode 1)

  ;; Suppress native compilation warnings
  (setq native-comp-async-report-warnings-errors nil)

  ;; basic settings
  (setq inhibit-startup-message t)
  (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (setq visible-bell t)

  ;; lines
  (setq display-line-numbers-type t)
  (global-display-line-numbers-mode 1)
  ;; (global-hl-line-mode 1)

  ;; short answer
  (setq use-short-answers t)

  ;; attempting to make dashboard the default buffer instead of scratch
  (setq initial-buffer-choice (lambda () (get-buffer-create "*dashboard*")))

  ;; insert \n with C-n
  (setq next-line-add-newlines t)

  ;; overwrite selection when pasting
  (delete-selection-mode 1)
#+end_src
** Auto-save
This sets auto-save/back-up files to a specific directory rather than littering them everywhere
#+begin_src emacs-lisp

(make-directory "~/.emacs.d/auto-save-list/" t)
(make-directory "~/.emacs.d/backups/"       t)

(setq auto-save-file-name-transforms
      `((".*" ,(expand-file-name "auto-save-list/" user-emacs-directory) t))
      backup-directory-alist
      `((".*" . ,(expand-file-name "backups/" user-emacs-directory))))

#+end_src
** God mode
make emacs a bit more modal
#+begin_src emacs-lisp
  (use-package god-mode
    :straight t
    :init
    (setq god-mode-enable-function-key-translation nil)
    :bind (("<escape>" . god-local-mode)
           :map god-local-mode-map
           ("i" . god-local-mode))
    :config
    (god-mode-all))

  ;; making the cursor change with god mode status
  (defun my-god-mode-update-cursor ()
    (setq cursor-type (if god-local-mode 'box 'bar)))

  (add-hook 'god-mode-enabled-hook 'my-god-mode-update-cursor)
  (add-hook 'god-mode-disabled-hook 'my-god-mode-update-cursor)

#+end_src

* Appearance
** Theme

#+begin_src emacs-lisp
  ;; theme
  (setq modus-themes-to-toggle '(modus-operandi-tritanopia modus-vivendi-tritanopia))

  (setq modus-themes-bold-constructs t)
  (setq modus-themes-italic-constructs t)
  (setq modus-themes-syntax '(alt-syntax))

  (setq modus-themes-fringes 'subtle)

  (setq modus-themes-common-palette-overrides
        '((border-mode-line-active unspecified)
          (border-mode-line-inactive unspecified)
  	  (bg-mode-line-active bg-active)))

  (setq modus-themes-headings
        '((1 . (rainbow overline background 1.4))
          (2 . (rainbow background 1.3))
          (3 . (rainbow bold 1.2))
          (t . (semilight 1.1))))

  (setq modus-themes-scale-headings t)

  (load-theme 'modus-vivendi-tritanopia t)

#+end_src


** Font

#+begin_src emacs-lisp

  ;; font
  (set-face-attribute
   'default nil
   :family "Iosevka Extended"
   :height 120)

  ;; ligatures
  (use-package ligature
    :straight t
    :config
    ;; Enable all Iosevka ligatures 
    (ligature-set-ligatures t
        			  '("<--" "<---" "<->" "<-->" "<--->" "<---->"
        			    "<==" "<===" "<=>" "<==>" "<===>" "<====>"
        			    "<~~" "<~" "~>" "~~>"
        			    "::" ":::" "==" "!=" "===" "!=="
        			    ":=" ":-" ":+" "<*" "<*>" "*>"
        			    "<|" "<|>" "|>" "+:" "-:" "=:" "<******>"
        			    "++" "+++"))
    (global-ligature-mode t))


#+end_src

*** Rainbow-mode

#+begin_src emacs-lisp
  (straight-use-package 'rainbow-mode)

#+end_src

** Doom Modeline

For the icons you have to run nerd-icons-install-fonts.

#+begin_src emacs-lisp
    ;; modeline
    (setq doom-modeline-support-imenu t)
    (setq doom-modeline-height 25)
    (setq doom-modeline-bar-width 1)
    (setq doom-modeline-hud t)
    (setq doom-modeline-icon t)
    (setq doom-modeline-major-mode-icon t)
    (setq doom-modeline-majornnn-mode-color-icon t)
    (setq doom-modeline-buffer-state-icon t)
    (setq doom-modeline-buffer-modification-icon t)
    (setq doom-modeline-lsp-icon t)
    (setq doom-modeline-buffer-name t)
    (setq doom-modeline-highlight-modified-buffer-name t)
    (setq doom-modeline-column-zero-based t)
    (setq doom-modeline-percent-position '(-3 "%p"))
    (setq doom-modeline-position-line-format '("L%l"))
    (setq doom-modeline-position-column-format '("C%c"))
    (setq doom-modeline-position-column-line-format '("%l:%c"))
    (setq doom-modeline-enable-word-count t)
    (setq doom-modeline-total-line-number t)

    (use-package doom-modeline
      :straight t
      :config
      (doom-modeline-mode 1))

  (display-time-mode 1)
  (setq display-time-day-and-date t)
  (setq display-time-default-load-average nil)

#+end_src



** Dashboard

#+begin_src emacs-lisp
  ;; dashboard
  (straight-use-package 'dashboard)
  (require 'dashboard)
  (dashboard-setup-startup-hook)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (setq dashboard-set-navigator t)
  (setq dashboard-vertically-center-content t)
  (setq dashboard-display-icons-p t)     
  (setq dashboard-icon-type 'nerd-icons)
  (setq dashboard-set-heading-icons t)
  (setq dashboard-set-file-icons t)
  (add-to-list 'dashboard-items '(agenda) t)
  (setq dashboard-week-agenda t)

  (setq dashboard-startupify-list '(dashboard-insert-navigator
                                    dashboard-insert-newline
                                    dashboard-insert-items))

  (setq dashboard-items '((recents   . 10)
  			(bookmarks . 10)
  			(agenda    . 20)))

#+end_src

** Zoom
#+begin_src emacs-lisp
  (use-package zoom
    :straight t          
    :config
    (custom-set-variables
     '(zoom-size '(0.7 . 0.7)))
    (zoom-mode 1))

#+end_src

* Navigation
** Custom-keybindings
#+begin_src emacs-lisp
(global-set-key (kbd "C-q") 'other-window)
#+end_src
** Recent files
#+begin_src emacs-lisp
;; Recent files
(recentf-mode 1)
(setq recentf-max-saved-items 50)
(global-set-key (kbd "C-x C-r") 'counsel-recentf)

#+end_src
** Which-key
To give an overview of shortcut options

#+begin_src emacs-lisp
;; which-key
(use-package which-key
  :straight t
  :config
  (which-key-mode 1))

#+end_src
** Recent commands

#+begin_src emacs-lisp
;; amx - command frequency tracking for M-x
(use-package amx
  :straight t
  :config
  (amx-mode 1))

#+end_src
** Search
*** Swiper

#+begin_src emacs-lisp
;; search
(global-set-key (kbd "C-s") #'swiper) 

#+end_src
*** Orderless
Basically fuzzy match when searching for files
#+begin_src emacs-lisp
  (use-package orderless
    :straight t
    :config
    (setq completion-styles '(orderless)
  	orderless-matching-styles '(orderless-flex)
    	read-buffer-completion-ignore-case t))

#+end_src

*** Avy (Vimium-style navigation)

#+begin_src emacs-lisp
  (use-package avy
    :straight t
    :bind
    (("C-."   . avy-goto-char-timer))) 

#+end_src

** Context: Marginalia
#+begin_src emacs-lisp
  ;; Marginalia: annotations in completion lists
  (use-package marginalia
    :straight t
    :init
    (marginalia-mode))

#+end_src
* Editing
** Auto complete
 
*** Ivy, Counsel

#+begin_src emacs-lisp
  (use-package ivy
      :straight t
      :config
      (ivy-mode 1))

  (setq ivy-re-builders-alist
      '((swiper . ivy--regex-plus)
        (t      . ivy--regex-fuzzy)))
  
  (use-package counsel
      :straight t
      :after ivy
      :config
      (require 'counsel)
      (counsel-mode 1)
      (setq ivy-use-virtual-buffers t)
      (setq ivy-initial-inputs-alist nil)) ;; Remove ^ from M-x

#+end_src

*** Company

#+begin_src emacs-lisp
  ;; company
  (use-package company
    :straight t
    :init
    (global-company-mode)
    :hook ((emacs-lisp-mode . company-mode))
    :custom
    (company-backends '((company-capf company-dabbrev-code)))
    (company-idle-delay 0.1)
    (company-minimum-prefix-length 1))

#+end_src
*** LSP-mode

#+begin_src emacs-lisp
  ;;lsp mode
  (use-package lsp-mode
    :after company
    :straight t
    :init
    (setq lsp-completion-provider :capf) 
    :hook ((python-mode . lsp-deferred)
           (ess-r-mode  . lsp-deferred)
           (julia-mode  . lsp-deferred))
    :config
    (lsp-enable-which-key-integration t))

  (use-package lsp-ui
    :straight t
    :config
    (setq lsp-ui-doc-enable t))


#+end_src

*** Minibuffer history

#+begin_src emacs-lisp
;; keep minibuffer history across sessions 
(use-package savehist
  :straight (:type built-in)     
  :init
  (savehist-mode 1))
#+end_src

** To-Do comment highlighting

#+begin_src emacs-lisp
;; hl-todo
(straight-use-package 'hl-todo)
(global-hl-todo-mode)

#+end_src

** Undo-tree

#+begin_src emacs-lisp
  (straight-use-package 'undo-tree)
  (global-undo-tree-mode)

  (global-set-key (kbd "C-x C-/") 'undo)
  ;; Bind undo-tree-visualize to a new key, e.g., C-c u
  (define-key undo-tree-map (kbd "C-c _") 'undo-tree-visualize)
  
#+end_src

* Languages
** Quarto + MD

#+begin_src emacs-lisp

  ;; modified version of quarto-mode TODO:
  (use-package quarto-mode
    :straight (:local-repo "~/code/emacs/quarto-emacs"))

  ;; markdown
  (use-package markdown-mode
    :mode ("\\.md\\'" "\\.markdown\\'")
    :config
    (setq markdown-command "pandoc"))


  (use-package better-quarto
    :straight nil          
    :load-path "~/.emacs.d/elisp/better-quarto")

  (add-hook 'quarto-mode-hook #'better-quarto-mode)

  (add-hook 'markdown-mode-hook
            (lambda ()
              (when (and buffer-file-name
                         (string-match-p "\\.\\(qmd\\|rmd\\)\\'" buffer-file-name))
                (better-quarto-mode 1))))

#+end_src

** Julia + R + Python

#+begin_src emacs-lisp
  ;; Jupyter
  (straight-use-package 'jupyter)

  ;; julia
  (use-package julia-snail
    :straight t
    :hook (julia-mode . julia-snail-mode)
    :init
    ;; Ask Snail to load its Org-Babel bridge (ob-julia.el)
    (add-to-list 'julia-snail-extensions 'ob-julia))


  (setq julia-snail-propagate-to-indirect-buffers t)

  ;; (use-package julia-mode
  ;;   :straight t
  ;;   :mode "\\.jl\\'"
  ;;   :hook (julia-mode . lsp-deferred))

  ;; (use-package lsp-julia
  ;;   :straight t
  ;;   :after lsp-mode)


  ;; (add-hook 'julia-mode-hook #'lsp-mode)

  ;; R
  (use-package ess
    :straight t
    :hook (ess-r-mode . (lambda ()
                          (require 'lsp-mode)
                          (lsp-deferred))))
  ;;   :hook (ess-julia-mode . (lambda ()
  ;;       			    (require 'lsp-julia)
  ;;       			    (lsp-deferred))))

  ;; python
  (use-package elpy
    :straight t
    :init
    (elpy-enable)
    :hook (elpy-mode . lsp-deferred))

  (setq python-shell-interpreter "ipython"
        python-shell-interpreter-args "-i --simple-prompt")



#+end_src

** Nix

#+begin_src emacs-lisp 
  ;; nix
  (use-package nix-mode
    :straight t
    :mode "\\.nix\\'")

#+end_src

** English (Spellcheck)

Dump dictionary into emacs.d for simplicity using:
aspell -d en dump master | aspell -l en expand > ~/.emacs.d/english.words

#+begin_src emacs-lisp
  (setq ispell-alternate-dictionary
        (expand-file-name "~/.emacs.d/english.words"))
#+end_src

* Applications
** Magit

Emacs Git client + diff highlights

#+begin_src emacs-lisp
;; magit
(use-package magit
  :straight t
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))

;; git-gutter
(straight-use-package 'git-gutter)
(global-git-gutter-mode +1)

#+end_src

** Org
#+begin_src  emacs-lisp
  (use-package org
    :straight (:type built-in)
    :hook (org-babel-after-execute . org-redisplay-inline-images)
    :custom
    (org-confirm-babel-evaluate nil)
    :config
    (require 'ob-julia)        
    (add-to-list 'org-babel-load-languages '(julia . t))
    (org-babel-do-load-languages
     'org-babel-load-languages
     '((python . t) (R . t) (julia . t) (shell . t)
       (css . t) (js . t) (latex . t) (emacs-lisp . t)
       (jupyter . t)))
    
      ;; Settings
      (setq org-confirm-babel-evaluate nil
    	org-startup-with-inline-images t
    	org-babel-eval-verbose t
    	org-startup-folded 'overview
    	org-format-latex-options (plist-put org-format-latex-options :scale 1.5)
    	org-hide-emphasis-markers t))

    (require 'org-tempo)

    (use-package org-auto-tangle
      :straight t
      :hook (org-mode . org-auto-tangle-mode)   
      :custom
      (org-auto-tangle-default t)) 

    (use-package org-bullets ;; make bullets prettier
      :straight t
      :config
      (add-hook 'org-mode-hook (lambda () (org-bullets-mode 1))))

    (use-package corg
      :straight (:host github :repo "isamert/corg.el")) ;; this adds auto-complete to src block header args

#+end_src

#+begin_src emacs-lisp
  ;; expense tracking template
  (defun insert-expense-template ()
    "Insert expense template with user-specified month and year."
    (interactive)
    (let* ((month (read-string "Enter month (e.g., December): "))
           (year (read-string "Enter year (e.g., 2025): "))
           (template-file (expand-file-name "~/org/templates/expenses.org"))
           (content (with-temp-buffer
                      (insert-file-contents template-file)
                      (buffer-string))))
      ;; Replace %B with month, %Y with year
      (setq content (replace-regexp-in-string "%B" month content))
      (setq content (replace-regexp-in-string "%Y" year content))
      (insert content)))


#+end_src

** Elfeed

#+begin_src emacs-lisp

  (use-package elfeed
    :straight t)

  (use-package elfeed-tube
    :straight t
    :after elfeed
    :demand t
    :config
    (elfeed-tube-setup))

  (use-package elfeed-org
    :straight t
    :after elfeed
    :config
    (elfeed-org)
    (setq rmh-elfeed-org-files (list "~/org/elfeed.org")))

  ;; filter condition
  (setq elfeed-search-filter "@1-week-ago +unread")
  (setq elfeed-search-parse-filter-expiry-words t)

  ;; cusom display
  (setq elfeed-show-entry-switch #'elfeed-display-buffer)
  (defun elfeed-display-buffer (buf &optional act)
    (pop-to-buffer buf)
    (set-window-text-height (get-buffer-window) (round (* 0.7 (frame-height)))))

  (defun my-elfeed-show-setup ()
    (setq-local elfeed-show-entry-switch #'elfeed-display-buffer))

  (add-hook 'elfeed-show-mode-hook #'my-elfeed-show-setup)


#+end_src

** Treemacs

#+begin_src emacs-lisp
  (use-package treemacs
    :straight t
    :commands treemacs)
#+end_src
* TODO
** Coding
- yasnippet for org mode header automation
- ess-view-data, ess-plot
- styling for org exports?
- pdf-tools, ox-quarto?
- org-latex-impatient, org-edit-latex
- how to make plots show in a buffer?
  
** Living in emacs
- org agenda - org-caldav?
- how would calendar notifications work? appt
- email - mu4e or notmuch https://www.liwen.name/articles/use-mbsync-n-mu4e-for-emails-in-emacs
- org-ref, org-present
- password manager?
- LLM in emacs? for autocomplete?
- default search engine for eww
- Music player
- habit tracking

















