#+title: Luke's Emacs configuration
#+PROPERTY: header-args:emacs-lisp :tangle config.el :results silent
#+auto_tangle: t

* Core
** Straight.el

For automating package installation

#+begin_src emacs-lisp
;; Bootstrap straight.el
(defvar bootstrap-version)
(let ((bootstrap-file
       (expand-file-name "straight/repos/straight.el/bootstrap.el" user-emacs-directory))
      (bootstrap-version 6))
  (unless (file-exists-p bootstrap-file)
    (with-current-buffer
        (url-retrieve-synchronously
         "https://raw.githubusercontent.com/radian-software/straight.el/develop/install.el"
         'silent 'inhibit-cookies)
      (goto-char (point-max))
      (eval-print-last-sexp)))
  (load bootstrap-file nil 'nomessage))

;; Configure use-package to use straight.el by default
(straight-use-package 'use-package)
(setq straight-use-package-by-default t)

#+end_src


** Basics
Alerts, font, toolbar, bell, line numbers

#+begin_src emacs-lisp
  ;; Suppress native compilation warnings
  (setq native-comp-async-report-warnings-errors nil)

  ;; font
  (set-face-attribute 'default nil :height 110)

  ;; basic settings
  (setq inhibit-startup-message t)
  (tool-bar-mode -1)
  (menu-bar-mode -1)
  (scroll-bar-mode -1)
  (setq visible-bell t)

  ;; lines
  (setq display-line-numbers-type t)
  (global-display-line-numbers-mode 1)
  (global-hl-line-mode 1)

  ;; short answer
  (setq use-short-answer t)

  ;; attempting to make dashboard the default buffer instead of scratch
  (setq initial-buffer-choice (lambda () (get-buffer-create "*dashboard*")))


#+end_src


* Appearance
** Theme

#+begin_src emacs-lisp
;; theme
(use-package doom-themes
    :straight t
    :config
    (load-theme 'doom-henna t))

(add-hook 'after-init-hook
            (lambda ()
              (load-theme 'doom-henna t)))

   ;; Trusted themes
(custom-set-variables
   '(custom-safe-themes
     '("9b9d7a851a8e26f294e778e02c8df25c8a3b15170e6f9fd6965ac5f2544ef2a9"
       "22a0d47fe2e6159e2f15449fcb90bbf2fe1940b185ff143995cc604ead1ea171"
       "b754d3a03c34cfba9ad7991380d26984ebd0761925773530e24d8dd8b6894738"
       "4d5d11bfef87416d85673947e3ca3d3d5d985ad57b02a7bb2e32beaf785a100e"
       "7771c8496c10162220af0ca7b7e61459cb42d18c35ce272a63461c0fc1336015"
       "77fff78cc13a2ff41ad0a8ba2f09e8efd3c7e16be20725606c095f9a19c24d3d"
       "f64189544da6f16bab285747d04a92bd57c7e7813d8c24c30f382f087d460a33"
       default)))
  (custom-set-faces
)


(defun light-theme ()
  "Load light theme."
  (interactive)
  (when (car custom-enabled-themes)
    (disable-theme (car custom-enabled-themes)))
  (load-theme 'doom-bluloco-light t))

(defun dark-theme ()
  "Load dark theme."
  (interactive)
  (when (car custom-enabled-themes)
    (disable-theme (car custom-enabled-themes)))
  (load-theme 'doom-henna t))

#+end_src

** Doom Modeline

For the icons you have to run nerd-icons-install-fonts.

#+begin_src emacs-lisp
;; modeline
(use-package doom-modeline
  :straight t
  :config
  (doom-modeline-mode 1))

#+end_src




** Dashboard

#+begin_src emacs-lisp
;; dashboard
(straight-use-package 'dashboard)
(require 'dashboard)
(dashboard-setup-startup-hook)
(setq dashboard-startup-banner 'logo)
(setq dashboard-set-heading-icons t)
(setq dashboard-set-file-icons t)
(setq dashboard-set-navigator t)

#+end_src


** Zoom
#+begin_src emacs-lisp
(use-package zoom
  :straight t          ; install via straight.el
  :custom
  (zoom-size '(0.618 . 0.618)) ; width × height ratios
  :config
  (zoom-mode 1))

#+end_src










* Navigation

** Recent files

#+begin_src emacs-lisp
;; Recent files
(recentf-mode 1)
(setq recentf-max-saved-items 50)
(global-set-key (kbd "C-x C-r") 'counsel-recentf)

#+end_src


** Which-key

To give an overview of shortcut options

#+begin_src emacs-lisp
;; which-key
(use-package which-key
  :straight t
  :config
  (which-key-mode 1))

#+end_src



** Recent commands

#+begin_src emacs-lisp
;; amx - command frequency tracking for M-x
(use-package amx
  :straight t
  :config
  (amx-mode 1))

#+end_src



** Search

With swiper

#+begin_src emacs-lisp
;; search
(global-set-key (kbd "C-s") #'swiper) ;; C-s

#+end_src

Vimium-style navigation

#+begin_src emacs-lisp
(use-package avy
  :straight t
  :bind
  (("M-f"   . avy-goto-char-timer) ; type a few chars, jump instantly
   ("M-g f" . avy-goto-line)       ; jump to line
   ("M-g w" . avy-goto-word-1)))   ; jump to word

#+end_src



#+begin_src emacs-lisp
  (use-package consult
    :straight t
    :bind
    (("C-x b" . consult-buffer)    ; enhanced buffer switcher
     ("M-y"   . consult-yank-pop)  ; better kill-ring browsing
     ("C-M-l" . consult-imenu))    ; jump to headings, defs, etc.
    :hook
    (completion-list-mode . consult-preview-at-point-mode))

  ;; Embark: context-sensitive actions
(use-package embark
  :straight t
  :bind
  (("C-." . embark-act)       ; do  
   ("C-;" . embark-dwim)       ; default
   ("C-h B" . embark-bindings)) ; available actions for current keymap
  :init
  (setq embark-action-indicator
        (lambda (&rest args)
          (which-key--show-keymap "Embark" (car args) nil nil 'no-paging)
          #'which-key--hide-popup-ignore-command)
        embark-become-indicator embark-action-indicator))

;; Embark-consult: previews & collect buffers for Embark
(use-package embark-consult
  :straight t
  :after (embark consult)
  :demand t)                    

;; Marginalia: annotations in completion lists
(use-package marginalia
  :straight t
  :init
  (marginalia-mode 1)
  :custom
  (marginalia-annotators
   '(marginalia-annotators-heavy     
     marginalia-annotators-light
     nil)))                          

#+end_src

** Window navigation

#+begin_src emacs-lisp
(use-package ace-window
  :straight t
  :bind
  (("C-<tab>" . ace-window))          ; displays single-letter hints in each window
  :custom
  (aw-scope 'global))             ; work across all frames

#+end_src















* Editing
** Auto complete

With ivy, counsel, company, and eglot

#+begin_src emacs-lisp
;; auto-complete
(use-package ivy
    :straight t
    :config
    (ivy-mode 1))

(use-package counsel
    :straight t
    :after ivy
    :config
    (require 'counsel)
    (counsel-mode 1)
    (setq ivy-use-virtual-buffers t)
    (setq ivy-initial-inputs-alist nil)) ;; Remove ^ from M-x


;; eglot-booster
(straight-use-package '(eglot-booster :type git :host github :repo "jdtsmith/eglot-booster"))
(with-eval-after-load 'eglot
    (require 'eglot-booster)
    (eglot-booster-mode))


(use-package company
  :straight t
  :demand t
  :custom
  (company-idle-delay 0.2)
  (company-minimum-prefix-length 1)
  :hook
  (after-init . global-company-mode)
  :config
  ;; Prevent Company from hijacking “<s TAB” in Org
  (defun my/company-org-tempo-inhibit (orig-fun command &optional arg &rest others)
    "Return nil for `company--prefix' when Org’s structure template
could expand, so TAB goes to `org-tempo'."
    (if (and (derived-mode-p 'org-mode)
             (looking-back "^<[a-zA-Z]*" (line-beginning-position)))
        nil                               ; inhibit Company
      (apply orig-fun command arg others))) ; otherwise run Company normally

  (advice-add 'company--prefix :around #'my/company-org-tempo-inhibit))
   
#+end_src


#+begin_src emacs-lisp
  ;; completion UI
(use-package vertico
  :straight t
  :init
  (vertico-mode 1)               ; enable globally
  :custom
  (vertico-cycle t))             ; wrap around when reaching top/bottom

;; keep minibuffer history across sessions 
(use-package savehist
  :straight (:type built-in)     
  :init
  (savehist-mode 1))


#+end_src

** Evil mode
General used for SPC leader key

#+begin_src emacs-lisp
  ;; vim-mode
  (setq evil-want-keybinding nil)
  (straight-use-package 'evil)
  (straight-use-package 'evil-collection)

  (require 'evil)
  (evil-mode 1)

  (when (require 'evil-collection nil t)
  (evil-collection-init))

(use-package general
  :straight t     
  :demand t
  :config
  (general-create-definer leader-def
    :prefix "SPC"
    :states '(normal visual)))

  (straight-use-package 'evil-org-mode)
  (when (require 'evil-org-mode nil t)
  (add-hook 'org-mode-hook 'evil-org-mode))


(straight-use-package 'evil-org-mode)
(when (require 'evil-org-mode nil t)
  (add-hook 'org-mode-hook 'evil-org-mode))

  
#+end_src

TODO: expand evil mode configuration

** Syntax checking

with flycheck and tree-sitter

#+begin_src emacs-lisp
;; flycheck
(use-package flycheck
  :init (global-flycheck-mode)
  :config
  ;; Disable flycheck in modes where eglot provides diagnostics
  (setq flycheck-disabled-checkers '(emacs-lisp-checkdoc)))

(use-package treesit
  :straight (:type built-in)
  :when (treesit-available-p)
  :config
  (setq treesit-language-source-alist
        '((python "https://github.com/tree-sitter/tree-sitter-python")
          (javascript "https://github.com/tree-sitter/tree-sitter-javascript")
          (css "https://github.com/tree-sitter/tree-sitter-css")
          (html "https://github.com/tree-sitter/tree-sitter-html")
          (yaml "https://github.com/ikatyang/tree-sitter-yaml")
          (julia "https://github.com/tree-sitter/tree-sitter-julia")))

  (setq major-mode-remap-alist
        '((python-mode . python-ts-mode)
          (js-mode . js-ts-mode)
          (css-mode . css-ts-mode)
          (html-mode . html-ts-mode)
          (yaml-mode . yaml-ts-mode))))

(defun install-treesit-grammars ()
  "Install tree-sitter grammars for configured languages."
  (interactive)
  (dolist (lang '(python javascript css html yaml julia))
    (unless (treesit-language-available-p lang)
      (treesit-install-language-grammar lang))))


#+end_src



** To-Do comment highlighting

#+begin_src emacs-lisp
;; hl-todo
(straight-use-package 'hl-todo)
(global-hl-todo-mode)

#+end_src

** Replace

#+begin_src emacs-lisp
(use-package anzu
  :straight t
  :init (global-anzu-mode 1)
  :bind
  (("M-%"   . anzu-query-replace)        ; replaces default query-replace
   ("C-M-%" . anzu-query-replace-regexp)))

#+end_src


* Languages
** HTML, CSS, JS
#+begin_src emacs-lisp
;; web-mode
(use-package web-mode
  :mode ("\\.html?\\'" "\\.css\\'" "\\.js\\'" "\\.jsx\\'" "\\.tsx\\'" "\\.vue\\'")
  :config
  (setq web-mode-markup-indent-offset 2)
  (setq web-mode-css-indent-offset 2)
  (setq web-mode-code-indent-offset 2))

#+end_src


** Quarto + languages

#+begin_src emacs-lisp

  ;; test version of quarto-mode TODO:
  (use-package quarto-mode
    :straight (:local-repo "~/code/emacs/quarto-emacs"))

    ;; poly-mode
    (straight-use-package 'polymode)

    ;; markdown
    (use-package markdown-mode
      :mode ("\\.md\\'" "\\.markdown\\'")
      :config
      (setq markdown-command "pandoc"))

    ;; yaml
    (use-package yaml-mode
      :mode ("\\.yml\\'" "\\.yaml\\'"))

    ;; R
    (use-package ess
      :defer t
      :config
      (setq ess-style 'RStudio)
      (setq ess-offset-continued 'straight)
      (setq ess-expression-offset 0))

    ;; julia
    (use-package julia-mode
      :mode "\\.jl\\'")

#+end_src


*** Using my own code (better-quarto.el)

#+begin_src emacs-lisp

(use-package better-quarto
  :straight nil          
  :load-path "~/.emacs.d/elisp/better-quarto"
  :after general)
#+end_src



** Nix

#+begin_src emacs-lisp 
;; nix
(use-package nix-mode
  :mode "\\.nix\\'")

#+end_src




















* Applications

** Magit

Emacs Git client + diff highlights

#+begin_src emacs-lisp
;; magit
(use-package magit
  :straight t
  :bind ("C-x g" . magit-status)
  :config
  (setq magit-display-buffer-function #'magit-display-buffer-same-window-except-diff-v1))

;; git-gutter
(straight-use-package 'git-gutter)
(global-git-gutter-mode +1)

#+end_src


** Vterm

Terminal emulator in emacs

#+begin_src emacs-lisp
  ;; vterm
  (require 'vterm)
#+end_src


** Org
#+begin_src emacs-lisp
  (use-package org
    :defer t
    :init
    ;; files that feed the agenda
    (setq org-agenda-files '("~/org/inbox.org"
                             "~/org/projects.org"
                             "~/org/calendar.org"))

    ;; custom TODO workflow
    (setq org-todo-keywords
          '((sequence "TODO(t)" "NEXT(n)" "|" "DONE(d)")
            (sequence "WAIT(w)" "|" "CANCELLED(c)")))
    ;; show deadlines 7 days ahead
    (setq org-deadline-warning-days 7)

    ;; diary integration for Calendar -> appears in agenda
    (setq org-agenda-include-diary t)  ; diary entries from `M-x calendar`
    :bind (("C-c a" . org-agenda)      ; quick agenda
           ("C-c c" . org-capture)))

  (setq diary-file "~/org/diary")


(require 'org-tempo)

(use-package org-auto-tangle
  :straight t
  :hook (org-mode . org-auto-tangle-mode)   
  :custom
  (org-auto-tangle-default t)) 

  (use-package corg
  :straight (corg :host github :repo "isamert/corg.el") 
  :hook (org-mode . corg-mode)
  :custom
  (corg-header-minimum-chars 1)) ; complete after “<s” etc.


#+end_src





** Elfeed

#+begin_src emacs-lisp
  (use-package elfeed
    :straight t)

  (use-package elfeed-tube
    :straight t
    :after elfeed
    :demand t
    :config
    (elfeed-tube-setup))

  (load-file (expand-file-name "feeds.el" (expand-file-name "rss" user-emacs-directory)))

  (setq elfeed-show-entry-switch #'elfeed-display-buffer)

  (defun elfeed-display-buffer (buf &optional act)
    (pop-to-buffer buf)
    (set-window-text-height (get-buffer-window) (round (* 0.7 (frame-height)))))

  (setq elfeed-search-filter "@1-week-ago +unread")

  (setq elfeed-search-parse-filter-expiry-words t)


  (defun my-elfeed-show-setup ()
    (setq-local elfeed-show-entry-switch #'elfeed-display-buffer))

  (add-hook 'elfeed-show-mode-hook #'my-elfeed-show-setup)
   
#+end_src



* TODO

- eshell?












